<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>DCS Reference: A simple client example</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">DCS Reference
   &#160;<span id="projectnumber">2.4</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">A simple client example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is a simple example intended to illustrate the usage of the raw DCS API client components.</p>
<p><br/>
 </p>
<div class="fragment"><pre class="fragment">
<span class="comment">/****************************************************************************</span>
<span class="comment"> *****                                                                  *****</span>
<span class="comment"> *****                   Classification: UNCLASSIFIED                   *****</span>
<span class="comment"> *****                    Classified By:                                *****</span>
<span class="comment"> *****                    Declassify On:                                *****</span>
<span class="comment"> *****                                                                  *****</span>
<span class="comment"> ****************************************************************************</span>
<span class="comment"> *                                                                           </span>
<span class="comment"> *             </span>
<span class="comment"> * Developed by: Naval Research Laboratory, Tactical Electronic Warfare Div. </span>
<span class="comment"> *               EW Modeling &amp; Simulation, Code 5770 </span>
<span class="comment"> *               4555 Overlook Ave.                                          </span>
<span class="comment"> *               Washington, D.C. 20375-5339                                 </span>
<span class="comment"> *                                                                           </span>
<span class="comment"> * For more information please send email to simdis@enews.nrl.navy.mil</span>
<span class="comment"> *</span>
<span class="comment"> * 2002 - U.S. Naval Research Laboratory.</span>
<span class="comment"> *</span>
<span class="comment"> * The U.S. Government retains all rights to use, duplicate, distribute,     </span>
<span class="comment"> * disclose, or release this software.</span>
<span class="comment"> *</span>
<span class="comment"> */</span>

<span class="comment">// // // // // // // // // // // // // // // // // // // // // // //</span>
<span class="comment">// sclient - a simple client program implemented from the DCS API</span>

<span class="preprocessor">#include &lt;sstream&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;signal.h&gt;</span>
<span class="preprocessor">#include &quot;DCS.h&quot;</span>

<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;conio.h&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">// // // // // // // // // // // // // // // // // // // // // // //</span>
<span class="comment">// Character string specifying the network address of the network</span>
<span class="comment">// interface to use for data transmission. To use any network</span>
<span class="comment">// interface (INADDR_ANY), set to NULL.</span>
<span class="preprocessor">#define IFACE NULL</span>
<span class="preprocessor"></span>
<span class="comment">// flag to denote the client&#39;s status</span>
<span class="keywordtype">int</span> running=1;


<span class="comment">// // // // // // // // // // // // // // // // // // // // // // //</span>
<span class="comment">// In order to properly stop the client, we set a signal that allows</span>
<span class="comment">// the user to stop the process by pressing Ctl C </span>
<span class="keywordtype">void</span> sighandler(<span class="keywordtype">int</span>)
{
  running=0;
  printf(<span class="stringliteral">&quot;Signaled\n&quot;</span>);
  <span class="keywordflow">return</span>;
}


<span class="comment">// // // // // // // // // // // // // // // // // // // // // // //</span>
<span class="comment">// main program loop</span>
<span class="keywordtype">int</span> main()
{
  std::stringstream sstr;
  <span class="comment">//char buffer[256];</span>
  <a class="code" href="structDCSDisc_1_1DCSDiscover.html" title="DCS Server discovery class.">DCSDisc::DCSDiscover</a> discover;
  <a class="code" href="classDCSConsoleLogger.html" title="A class for logging DCS data structures to the console.">DCSConsoleLogger</a> logger;
  <a class="code" href="structDCSCom_1_1DCSClientInfo.html" title="Client info record.">DCSCom::DCSClientInfo</a> info;
  <a class="code" href="classDCSTimeHeader.html" title="Time header class.">DCSTimeHeader</a> time;
  <a class="code" href="classDCSScenarioHeader.html" title="Scenario header class.">DCSScenarioHeader</a> scenario;
  <a class="code" href="namespaceDCSCom.html#a661d41ae864f5fa6006fd6e32255e640" title="Header list for client.">DCSCom::HeaderList</a> headers;
  <a class="code" href="classDCSBaseData.html" title="abstract base class for DCS network data types.">DCSBaseData</a>* data;

  <span class="comment">// Set the signal so we can properly stop the client. </span>
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>  signal(SIGINT,sighandler);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keyword">struct </span>sigaction act;
  act.sa_handler=sighandler;
  sigemptyset(&amp;act.sa_mask);
  act.sa_flags=0;
<span class="preprocessor">#ifdef SA_RESTART</span>
<span class="preprocessor"></span>  act.sa_flags|=SA_RESTART;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  sigaction(SIGINT,&amp;act,NULL);

  <span class="comment">// Ignore SIGPIPE which will cause an exit when</span>
  <span class="comment">// reading from a broken socket more than once.</span>
  <span class="comment">// This only affects UNIX machines, Sun &amp; Linux in particular</span>
  signal(SIGPIPE,SIG_IGN);
<span class="preprocessor">#endif  </span>
<span class="preprocessor"></span>
  <span class="comment">// Socket initialization status, For the PC, this function calls the</span>
  <span class="comment">// WSAStartup function, which must be the first Windows Sockets function</span>
  <span class="comment">// called by an application or DLL. It allows an application or DLL</span>
  <span class="comment">// to specify the version of Windows Sockets required and to retrieve</span>
  <span class="comment">// details of the specific Windows Sockets implementation. The application</span>
  <span class="comment">// or DLL can only issue further Windows Sockets functions after a</span>
  <span class="comment">// successfully calling WSAStartup.</span>
  <span class="keywordflow">if</span> (!initializeSocket())
  {
    <span class="keywordtype">char</span> errormsg[256];
    sstr.str(<span class="stringliteral">&quot;&quot;</span>);
    sstr &lt;&lt; <span class="stringliteral">&quot;Error initializing socket: &quot;</span> &lt;&lt; getSockErr() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(sstr.str().c_str());

    getSockErrString(errormsg, 256);
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;System error message: &quot;</span>);
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(errormsg);
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;\n&quot;</span>);
    <span class="keywordflow">return</span> 0;
  }

  <span class="comment">// First locate a server on our local subnet (1 for TTL is subnet).  </span>
  <span class="keywordflow">if</span>(!DCSDisc::discoverClientInit(discover,1,IFACE))
  {
    <span class="keywordtype">char</span> errormsg[256];
    sstr.str(<span class="stringliteral">&quot;&quot;</span>);
    sstr &lt;&lt; <span class="stringliteral">&quot;Error initializing multicast socket for server discovery: &quot;</span> &lt;&lt; getSockErr() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(sstr.str().c_str());

    getSockErrString(errormsg, 256);
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;System error message: &quot;</span>);
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(errormsg);
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;\n&quot;</span>);
    <span class="keywordflow">return</span> 0;
  }

  DCSDisc::discoverRequest(discover);
  logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;Looking for a server\n&quot;</span>);
  
  <span class="comment">// Wait 2 minutes for the response</span>
  <span class="keywordflow">if</span>(!discover.<a class="code" href="structDCSDisc_1_1DCSDiscover.html#a6a73f6074741a31b6e97a45267d28f15">respond</a>-&gt;readReady(120,0))
  {
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;No server found.  Shutting down.\n&quot;</span>);
    finalizeSocket();
    <span class="keywordflow">return</span> 0;
  }

  DCSDisc::discoverReceive(discover);
  sstr.str(<span class="stringliteral">&quot;&quot;</span>);
  sstr &lt;&lt; <span class="stringliteral">&quot;Located server at &quot;</span> &lt;&lt; discover.<a class="code" href="structDCSDisc_1_1DCSDiscover.html#a28375d6bfa507783c7b8ba79d6d0a273">addr</a> &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; discover.<a class="code" href="structDCSDisc_1_1DCSDiscover.html#ae848f0a247b79509fb1389f046355d09">port</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
  logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(sstr.str().c_str());

  <span class="comment">// Establishs a connection to a listening server.</span>
  <span class="comment">//</span>
  <span class="comment">// Parameters:</span>
  <span class="comment">//  info:  a DCSClientInfo structure to be filled with data specific too the</span>
  <span class="comment">//         client being created. Resources required by DCSClientInfo will be</span>
  <span class="comment">//         allocated by this function. A matching call to clientDisconnect</span>
  <span class="comment">//         is required to properly free these resources, when finished.</span>
  <span class="comment">//  port:  an unsinged integer specifying the port with which to connect.</span>
  <span class="comment">//  addr:  network address of server with which to connect (eg. &quot;192.168.44.5&quot;).</span>
  <span class="comment">//  iface: interface to connect and receive data through (eg. &quot;127.0.0.1&quot;</span>
  <span class="comment">//         for loopback or the ip address of an installed network card).</span>
  <span class="comment">//</span>
  <span class="comment">// Returns:</span>
  <span class="comment">//  true if successful, false if failed. On failure, no resources will have</span>
  <span class="comment">//  been allocated, so a call to clientDisconnect is unnecessary.</span>
  <span class="keywordflow">if</span>(!<a class="code" href="namespaceDCSCom.html#a973f3b5fb73fbef128814626ad54eb52" title="Connect to server.">DCSCom::clientConnect</a>(info,discover.<a class="code" href="structDCSDisc_1_1DCSDiscover.html#ae848f0a247b79509fb1389f046355d09">port</a>,discover.<a class="code" href="structDCSDisc_1_1DCSDiscover.html#a28375d6bfa507783c7b8ba79d6d0a273">addr</a>,IFACE))
  {
    sstr.str(<span class="stringliteral">&quot;&quot;</span>);
    sstr &lt;&lt; <span class="stringliteral">&quot;Failed to connect to server: &quot;</span> &lt;&lt; getSockErr() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(sstr.str().c_str());
    DCSDisc::discoverFree(discover);
    finalizeSocket();
    <span class="keywordflow">return</span> 1;
  }
  <span class="keywordflow">else</span>
  {
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;Connected to server\n&quot;</span>);
  }

  <span class="comment">// Negotiates a connection with a server. This function is used to negotiate</span>
  <span class="comment">// a client connection that was made by clientConnect(). The negotiation is</span>
  <span class="comment">// handled separately from clientConnect for use by clients that are designed</span>
  <span class="comment">// to be multithreaded.</span>
  <span class="comment">//</span>
  <span class="comment">// Parameters:</span>
  <span class="comment">//   info:      a DCSClientInfo structure to receive the UDP data mode for </span>
  <span class="comment">//              the connection.</span>
  <span class="comment">//   time:      a DCSTimeHeader structure to be received by the client as </span>
  <span class="comment">//              part of the connection negotiation.</span>
  <span class="comment">//   scenario:  a DCSScenarioHeader structure to be received by the client</span>
  <span class="comment">//              as part of the connection negotiation.</span>
  <span class="comment">//   headers:   a HeaderList object to be filled with DCSBaseData derived</span>
  <span class="comment">//              objects received by the client as part of the connection</span>
  <span class="comment">//              negotiation.</span>
  <span class="comment">//   version:   an unsigned short to be filled the DCS protocol version</span>
  <span class="comment">//              number supported by the DCS server. If a client negotiaion</span>
  <span class="comment">//              fails, check this value to make sure it matches the version</span>
  <span class="comment">//              of the DCS protocol employed by the client. (optional)</span>
  <span class="comment">//</span>
  <span class="comment">// Returns:</span>
  <span class="comment">//  true if successful, false if failed. On failure, client connection is</span>
  <span class="comment">//  not closed by this function. The application should close the socket</span>
  <span class="comment">//  explicitly with a call to clientDisconnect if this function fails. The</span>
  <span class="comment">//  contents of the HeaderList, if any, will also have ot be destroyed</span>
  <span class="comment">//  explicitly through use of the &#39;delete&#39; operator.</span>
  <span class="keywordflow">if</span>(!<a class="code" href="namespaceDCSCom.html#a4e0de3ad0271a00b6c3c502cbd349895" title="Negotiate a new connection with server - without reading headers.">DCSCom::clientNegotiate</a>(info,time,scenario,headers))
  {
    sstr.str(<span class="stringliteral">&quot;&quot;</span>);
    sstr &lt;&lt; <span class="stringliteral">&quot;Failed to negotiate connection: &quot;</span> &lt;&lt; getSockErr() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(sstr.str().c_str());
    <span class="comment">// Closes an active connection and frees resources allocated for</span>
    <span class="comment">// DCSClientInfo by clientConnect.</span>
    <span class="comment">//</span>
    <span class="comment">// Parameters:</span>
    <span class="comment">//   info:  a DCSClientInfo structure containing data sepcific to the client</span>
    <span class="comment">//          to be disconnected. Resources allocated for this structure by</span>
    <span class="comment">//          clientConnect will be freed.</span>
    <span class="comment">//</span>
    <span class="comment">// Returns:</span>
    <span class="comment">//  true if successful, false if failed. Failure indicates that one or both</span>
    <span class="comment">//  of the data and client sockets did not exist.</span>
    <a class="code" href="namespaceDCSCom.html#ac9e3754df9490c60ca225b84672c5cdc" title="Close an active connection.">DCSCom::clientDisconnect</a>(info);
    DCSDisc::discoverFree(discover);
    finalizeSocket();
    <span class="keywordflow">return</span> 1;
  }
  <span class="keywordflow">else</span>
  {
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">&quot;\n\t   Press Q key to quit DCS Client\n&quot;</span> &lt;&lt; endl;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">&quot;\n\t Press Ctl-C key to quit DCS Client\n&quot;</span> &lt;&lt; endl;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    
    <span class="keywordtype">char</span> addr[DCS_ADDRSTRLEN];
    sstr.str(<span class="stringliteral">&quot;&quot;</span>);
    sstr &lt;&lt; <span class="stringliteral">&quot;Connection settings: &quot;</span> &lt;&lt; info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#a0090bbbe331569ff4ec5c91c2abc0758" title="Data transport type.">datatype</a> &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#a0f6cf7ae0c6580b70d6cae0afb45fc13" title="UDP connection.">datasock</a>-&gt;getPort() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#a0f6cf7ae0c6580b70d6cae0afb45fc13" title="UDP connection.">datasock</a>-&gt;getAddress(addr,<span class="keyword">sizeof</span>(addr)) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(sstr.str().c_str());
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(&amp;time);
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(&amp;scenario);

    sstr.str(<span class="stringliteral">&quot;&quot;</span>);
    sstr &lt;&lt; <span class="stringliteral">&quot;Received &quot;</span> &lt;&lt; headers.size() &lt;&lt; <span class="stringliteral">&quot; platforms\n&quot;</span>;
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(sstr.str().c_str());
    DCSCom::HeaderList::iterator iter=headers.begin();
    <span class="keywordflow">for</span>(;iter!=headers.end();iter++)
      logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(*iter);
  }

  
  <span class="comment">// Make a data requests to server. Initiaites a date request to server.</span>
  <span class="comment">// Data sent by server as a result of this request is to be read with</span>
  <span class="comment">// the readData function. Prior to using this function the client must</span>
  <span class="comment">// be connected to the server and the DCSClientInfo structure initialized</span>
  <span class="comment">// through a call to clientConnect.</span>
  <span class="comment">//</span>
  <span class="comment">// Parameters:</span>
  <span class="comment">//   info:     a DCSClientInfo structure specifying the socket with which </span>
  <span class="comment">//             data requests are to be sent.</span>
  <span class="comment">//   request:  an unsinged byte specifying the type of data request being</span>
  <span class="comment">//             made.</span>
  <span class="comment">//</span>
  <span class="comment">// Returns:</span>
  <span class="comment">//   true if successful, false if failed.</span>
  <span class="keywordflow">if</span> (!<a class="code" href="namespaceDCSCom.html#a524dd5bdcbb1ab8b2a99c1e6048e1218" title="Request data from server.">DCSCom::clientRequest</a>(info,<a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5abeae3303236ad66f89ebe073cfd0736c">DCSREQUEST_DATAMODE</a>))
  {
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;DCSREQUEST_DATAMODE failed\n&quot;</span>);
  }
  <span class="keywordflow">if</span> (!<a class="code" href="namespaceDCSCom.html#a524dd5bdcbb1ab8b2a99c1e6048e1218" title="Request data from server.">DCSCom::clientRequest</a>(info,<a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5ad9940fb6cd31901959e7e5a430531953">DCSREQUEST_TIME</a>))
  {
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;DCSREQUEST_TIME failed\n&quot;</span>);
  }
  <span class="keywordflow">if</span> (!<a class="code" href="namespaceDCSCom.html#a524dd5bdcbb1ab8b2a99c1e6048e1218" title="Request data from server.">DCSCom::clientRequest</a>(info,<a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5a9f620bffd1c11b5dad8a1740711cbf47">DCSREQUEST_SCENARIO</a>))
  {
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;DCSREQUEST_SCENARIO failed\n&quot;</span>);
  }
  <span class="keywordflow">if</span> (!<a class="code" href="namespaceDCSCom.html#a524dd5bdcbb1ab8b2a99c1e6048e1218" title="Request data from server.">DCSCom::clientRequest</a>(info,<a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5a500a73f0fcd562fee2e76323c2f82d34">DCSREQUEST_HEADERS</a>))
  {
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;DCSREQUEST_HEADERS failed\n&quot;</span>);
  }
  <span class="keywordflow">if</span> (!<a class="code" href="namespaceDCSCom.html#a524dd5bdcbb1ab8b2a99c1e6048e1218" title="Request data from server.">DCSCom::clientRequest</a>(info,<a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5aab9c975c5930c2428dccd1545e4f375d">DCSREQUEST_KEEPALIVE</a>))
  {
    logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;DCSREQUEST_KEEPALIVE failed\n&quot;</span>);
  }

  
  <span class="comment">// Get UDP data updates</span>
  <span class="keywordflow">while</span>(running)
  {
    <span class="comment">// Test server socket</span>
    <span class="comment">// All of these socket operations should have error tests.  Make sure</span>
    <span class="comment">// your application does.  </span>
    <span class="keywordflow">if</span>(info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#ad1f3a809e0bbe63c3f0229ac48318d83" title="TCP connection.">servsock</a>-&gt;readReady(0,5000))
    {
      <span class="comment">// See what type of data was received</span>
      int8_t byte;
      int32_t result=info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#ad1f3a809e0bbe63c3f0229ac48318d83" title="TCP connection.">servsock</a>-&gt;read(&amp;byte,<span class="keyword">sizeof</span>(byte));
      <span class="keywordflow">if</span>(result==SOCKET_ERROR||result==0)
      {
        logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;Lost connection to server\n&quot;</span>);
        running=0;
        <span class="keywordflow">continue</span>;
      }

      <span class="keywordflow">switch</span>(byte)
      {
        <span class="keywordflow">case</span> <a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5abeae3303236ad66f89ebe073cfd0736c">DCSREQUEST_DATAMODE</a>:
        {
          <span class="comment">// We requested the data mode from the server.</span>
          <span class="comment">// Server sends 1 byte for mode type (Unicast,Broadcast,Multicast).</span>
          <span class="comment">// Followed 2 bytes for port.</span>
          <span class="comment">// Followed by DCS_ADDRSTRLEN bytes as a string containing address.</span>
          <span class="comment">// If the type is Unicast, the server sends it&#39;s own address incase</span>
          <span class="comment">// the client would like to &#39;connect&#39; to that address.  </span>
          int8_t datatype;
          uint16_t dataport;
          <span class="keywordtype">char</span> dataaddr[DCS_ADDRSTRLEN];
          info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#ad1f3a809e0bbe63c3f0229ac48318d83" title="TCP connection.">servsock</a>-&gt;readAll(&amp;datatype,<span class="keyword">sizeof</span>(datatype));
          info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#ad1f3a809e0bbe63c3f0229ac48318d83" title="TCP connection.">servsock</a>-&gt;readAll(&amp;dataport,<span class="keyword">sizeof</span>(dataport));
          dataport=ntohs(dataport);
          info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#ad1f3a809e0bbe63c3f0229ac48318d83" title="TCP connection.">servsock</a>-&gt;readAll(dataaddr,<span class="keyword">sizeof</span>(dataaddr));
          sstr.str(<span class="stringliteral">&quot;&quot;</span>);
          sstr &lt;&lt; <span class="stringliteral">&quot;\nData settings: &quot;</span> &lt;&lt; datatype &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; dataport &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; dataaddr &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(sstr.str().c_str());
          <span class="keywordflow">break</span>;
        }
        <span class="keywordflow">case</span> <a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5ad9940fb6cd31901959e7e5a430531953">DCSREQUEST_TIME</a>:
          <span class="comment">// We requested the time header.</span>
          data=<a class="code" href="namespaceDCSCom.html#abf2050ec42f1dbf84e0ea8f9d5d880c0" title="Receive data from TCP data channel.">DCSCom::readTCPData</a>(info);
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;\nNew Time Header: \n&quot;</span>);
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(data);
          <span class="keyword">delete</span> data;
          <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5a9f620bffd1c11b5dad8a1740711cbf47">DCSREQUEST_SCENARIO</a>:
          <span class="comment">// We requested the scenario header.</span>
          data=<a class="code" href="namespaceDCSCom.html#abf2050ec42f1dbf84e0ea8f9d5d880c0" title="Receive data from TCP data channel.">DCSCom::readTCPData</a>(info);
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;\nNew Scenario Header: \n&quot;</span>);
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(data);
          <span class="keyword">delete</span> data;
          <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5af979bac23362eb3ac08c6e88b179045b">DCSREQUEST_EVENT</a>:
          <span class="comment">// The server sent us an event.</span>
          data=<a class="code" href="namespaceDCSCom.html#abf2050ec42f1dbf84e0ea8f9d5d880c0" title="Receive data from TCP data channel.">DCSCom::readTCPData</a>(info);
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;\nServer sent Event: \n&quot;</span>);
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(data);
          <span class="keyword">delete</span> data;
          <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5af255ca257ec48a21495eeab6b96f0833">DCSREQUEST_HEADER</a>:
          <span class="comment">// The server sent us a new header.</span>
          data=<a class="code" href="namespaceDCSCom.html#abf2050ec42f1dbf84e0ea8f9d5d880c0" title="Receive data from TCP data channel.">DCSCom::readTCPData</a>(info);
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;\nServer sent new Header: \n&quot;</span>);
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(data);
          <span class="keyword">delete</span> data;
          <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5a500a73f0fcd562fee2e76323c2f82d34">DCSREQUEST_HEADERS</a>:
        {
          <span class="comment">// Server is responding to our request for the headers.</span>
          <span class="comment">// It first sends the total number of headers.</span>
          <span class="comment">// Then sends each header.</span>
          int32_t total;
          
          info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#ad1f3a809e0bbe63c3f0229ac48318d83" title="TCP connection.">servsock</a>-&gt;readAll(&amp;total,<span class="keyword">sizeof</span>(total));
          total=ntohl(total);

          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;\nServer sent new Headers: \n&quot;</span>);
          <span class="keywordflow">while</span>(total--&gt;0)
          {
            data=<a class="code" href="namespaceDCSCom.html#abf2050ec42f1dbf84e0ea8f9d5d880c0" title="Receive data from TCP data channel.">DCSCom::readTCPData</a>(info);
            logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(data);
            <span class="keyword">delete</span> data;
          }
          <span class="keywordflow">break</span>;
        }
        <span class="keywordflow">case</span> <a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5a4fb56874b04cf6efbf819ba6c5eb7acf">DCSREQUEST_DISCONNECT</a>:
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;\nServer sent disconnect\n&quot;</span>);
          running=0;
          <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a class="code" href="DCSdefs_8h.html#a86381a2e8897f8ef0dc706fd4e79e1b5aab9c975c5930c2428dccd1545e4f375d">DCSREQUEST_KEEPALIVE</a>:
          <span class="comment">// A response to our probe.  Server is still there.</span>
          logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(<span class="stringliteral">&quot;\nServer is alive\n&quot;</span>);
          <span class="keywordflow">break</span>;
      }
    }
    
    <span class="comment">// Test Data socket - a real application would probably want to read</span>
    <span class="comment">// more than one at a time.</span>
    <span class="keywordtype">int</span> limit=100;
    <span class="keywordflow">while</span>(info.<a class="code" href="structDCSCom_1_1DCSClientInfo.html#a0f6cf7ae0c6580b70d6cae0afb45fc13" title="UDP connection.">datasock</a>-&gt;readReady(0,5000)&amp;&amp;--limit&gt;0)
    {
      <span class="comment">// We have something</span>
      data=<a class="code" href="namespaceDCSCom.html#a8989454e82fb299d1ea3cb646f2d43bb" title="Receive data from UDP data channel.">DCSCom::readUDPData</a>(info);

      <span class="comment">// Make sure it wasn&#39;t junk on the network that we want to ignore.  </span>
      <span class="keywordflow">if</span>(data)
      {
        logger.<a class="code" href="classDCSConsoleLogger.html#a2549c4322a918beca0322ffcbf6c3629" title="Log DCS data.">log</a>(data);
        <span class="keyword">delete</span> data;
      }
    }
    
    <span class="comment">// check for keyboard entry, more specifically the q key</span>
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (_kbhit())
    {
      <span class="keywordtype">char</span> keyPressed = _getch();
      <span class="keywordflow">if</span> (keyPressed == <span class="charliteral">&#39;q&#39;</span>)
        running=<span class="keyword">false</span>;
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  } <span class="comment">// end of while (running)</span>

  printf(<span class="stringliteral">&quot;Disconnecting\n&quot;</span>);
  <span class="comment">// Closes an active connection and frees resources allocated for</span>
  <span class="comment">// DCSClientInfo by clientConnect.</span>
  <span class="comment">//</span>
  <span class="comment">// Parameters:</span>
  <span class="comment">//   info:  a DCSClientInfo structure containing data sepcific to the client</span>
  <span class="comment">//          to be disconnected. Resources allocated for this structure by</span>
  <span class="comment">//          clientConnect will be freed.</span>
  <span class="comment">//</span>
  <span class="comment">// Returns:</span>
  <span class="comment">//  true if successful, false if failed. Failure indicates that one or both</span>
  <span class="comment">//  of the data and client sockets did not exist.</span>
  <a class="code" href="namespaceDCSCom.html#ac9e3754df9490c60ca225b84672c5cdc" title="Close an active connection.">DCSCom::clientDisconnect</a>(info);
  
  <span class="comment">// Free resources allocated for our discovery daemon.  </span>
  DCSDisc::discoverFree(discover);

  <span class="comment">// Socket finalization status, For the PC, this function calls the WSACleanup.</span>
  <span class="comment">// An application or DLL is required to perform a successful WSAStartup call</span>
  <span class="comment">// before it can use Windows Sockets services. When it has completed the use</span>
  <span class="comment">// of Windows Sockets, the application or DLL must call WSACleanup to</span>
  <span class="comment">// deregister itself from a Windows Sockets implementation and allow the</span>
  <span class="comment">// implementation to free any resources allocated on behalf of the</span>
  <span class="comment">// application or DLL. Any pending blocking or asynchronous calls issued by</span>
  <span class="comment">// any thread in this process are canceled without posting any notification</span>
  <span class="comment">// messages or without signaling any event objects. Any pending overlapped</span>
  <span class="comment">// send and receive operations (WSASend/WSASendTo/WSARecv/WSARecvFrom with</span>
  <span class="comment">// an overlapped socket) issued by any thread in this process are also</span>
  <span class="comment">// canceled without setting the event object or invoking the completion</span>
  <span class="comment">// routine, if specified. In this case, the pending overlapped operations</span>
  <span class="comment">// fail with the error status WSA_OPERATION_ABORTED. </span>
  <span class="comment">// Sockets that were open when WSACleanup was called are reset and</span>
  <span class="comment">// automatically deallocated .</span>
  <span class="comment">// There must be a call to WSACleanup for every successful call to WSAStartup</span>
  <span class="comment">// made by a task. Only the final WSACleanup for that task does the actual</span>
  <span class="comment">// cleanup; the preceding calls simply decrement an internal reference count</span>
  <span class="comment">// in the Ws2_32.dll.</span>
  finalizeSocket();

  <span class="keywordflow">return</span> 0;
}
</pre></div> </div></div><!-- contents -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title></title>
   
</head>
  <body>
           
<hr>    <br>
      2002-2008 U.S. Naval Research Laboratory. &nbsp;The 
U.S. Government retains   all rights  to use, duplicate, distribute, disclose,
 or release this document.   &nbsp;<br>
         <br>
         For further information regarding DCS or SIMDIS please visit <a
 href="https://simdis.nrl.navy.mil">https://simdis.nrl.navy.mil</a> or send e-mail to <a
 href="mailto:simdis@enews.nrl.navy.mil">simdis@enews.nrl.navy.mil</a>. &nbsp;<br>
         <br>
         Copies of DCS and SIMDIS, as well as this manual and other related 
 information,&nbsp;    may be obtained from <a
 href="https://simdis.nrl.navy.mil">https://simdis.nrl.navy.mil</a>.    &nbsp;<br>
         <br>
                 
<hr width="100%" size="2">   
<address><small>Generated at Mon Mar 26 2012 08:06:29 for the DCS API by <a
 href="http://www.stack.nl/%7Edimitri/doxygen/index.html">doxygen</a> 1.7.6.1.</small></address>
 <br>
 <br>
 <br>
 
</body>
</html>
